{
  "version": 3,
  "sources": ["../../../../../../../Users/kkk/Library/CloudStorage/OneDrive-Vanderbilt/Projects/Personal_website/netlify/functions/chat.js"],
  "sourceRoot": "/private/var/folders/x3/bpsmm2ld7j7gb8csq_pm5r_h0000gn/T/tmp-92243-M1tV26QcaEsw",
  "sourcesContent": ["/**\n * RAG Chat Endpoint - Netlify Serverless Function\n *\n * Handles chat queries with vector search and LLM streaming.\n *\n * Environment Variables:\n * - OPENAI_API_KEY: For generating query embeddings (text-embedding-3-small)\n * - DEEPSEEK_API_KEY: For LLM response streaming\n * - ALLOWED_ORIGIN: Optional domain for CORS validation (e.g., \"yourdomain.com\")\n *\n * Features:\n * - Rate limiting: 10 requests/minute per IP\n * - Input sanitization: HTML stripped, max 2000 chars\n * - Vector search with cosine similarity\n * - Streaming LLM responses\n * - Graceful fallbacks when API keys are not set\n */\n\nimport { createRequire } from 'module';\nconst require = createRequire(import.meta.url);\n\n// Lazy-load index data to avoid cold start penalty on every import\nlet indexData = null;\nfunction loadIndexData() {\n  if (!indexData) {\n    indexData = require('./data/index.json');\n  }\n  return indexData;\n}\n\n// Rate limiting: Map<IP, { start: number, count: number }>\nconst rateLimit = new Map();\n\n// Clean up old rate limit entries every 5 minutes\nconst CLEANUP_INTERVAL = 5 * 60 * 1000;\nconst RATE_WINDOW_MS = 60000;\nconst RATE_LIMIT_MAX = 10;\n\nlet lastCleanup = Date.now();\n\nfunction cleanupRateLimits() {\n  const now = Date.now();\n  if (now - lastCleanup < CLEANUP_INTERVAL) return;\n\n  lastCleanup = now;\n  for (const [ip, data] of rateLimit.entries()) {\n    if (now - data.start >= RATE_WINDOW_MS) {\n      rateLimit.delete(ip);\n    }\n  }\n}\n\n/**\n * Cosine similarity between two vectors\n */\nfunction cosine(a, b) {\n  let dot = 0, normA = 0, normB = 0;\n  for (let i = 0; i < a.length; i++) {\n    dot += a[i] * b[i];\n    normA += a[i] * a[i];\n    normB += b[i] * b[i];\n  }\n  const denom = Math.sqrt(normA) * Math.sqrt(normB);\n  return denom === 0 ? 0 : dot / denom;\n}\n\n// Cached reshaped vectors\nlet vectors = null;\n\n/**\n * Lazy load and reshape index data into vector objects\n */\nfunction initVectors() {\n  if (vectors) return vectors;\n\n  const data = loadIndexData();\n  const { dimensions, vectors: flat, metadata } = data;\n\n  vectors = metadata.map((m, i) => ({\n    ...m,\n    vec: flat.slice(i * dimensions, (i + 1) * dimensions)\n  }));\n\n  return vectors;\n}\n\n/**\n * Vector search - find top K most similar chunks\n */\nfunction search(queryVec, topK = 5) {\n  const data = initVectors();\n  return data\n    .map(d => ({ ...d, score: cosine(queryVec, d.vec) }))\n    .sort((a, b) => b.score - a.score)\n    .slice(0, topK);\n}\n\n/**\n * Keyword-based fallback search when no embedding API is available\n */\nfunction keywordSearch(query, topK = 5) {\n  const data = initVectors();\n  const queryWords = query.toLowerCase().split(/\\s+/).filter(w => w.length > 2);\n\n  if (queryWords.length === 0) {\n    return data.slice(0, topK).map(d => ({ ...d, score: 0 }));\n  }\n\n  return data\n    .map(d => {\n      const textLower = d.text.toLowerCase();\n      let score = 0;\n      for (const word of queryWords) {\n        if (textLower.includes(word)) {\n          score += 1;\n        }\n      }\n      // Normalize by query length\n      return { ...d, score: score / queryWords.length };\n    })\n    .sort((a, b) => b.score - a.score)\n    .slice(0, topK);\n}\n\n/**\n * Get embedding from OpenAI API\n */\nasync function getEmbedding(text) {\n  const apiKey = process.env.OPENAI_API_KEY;\n\n  if (!apiKey) {\n    // Return null to signal fallback to keyword search\n    return null;\n  }\n\n  const response = await fetch('https://api.openai.com/v1/embeddings', {\n    method: 'POST',\n    headers: {\n      'Authorization': `Bearer ${apiKey}`,\n      'Content-Type': 'application/json'\n    },\n    body: JSON.stringify({\n      model: 'text-embedding-3-small',\n      input: text,\n      dimensions: 384\n    })\n  });\n\n  if (!response.ok) {\n    const error = await response.text();\n    throw new Error(`OpenAI API error: ${response.status} - ${error}`);\n  }\n\n  const data = await response.json();\n  return data.data[0].embedding;\n}\n\n/**\n * Stream response from DeepSeek API\n */\nasync function streamDeepSeekResponse(prompt) {\n  const apiKey = process.env.DEEPSEEK_API_KEY;\n\n  if (!apiKey) {\n    // Return mock response for testing without API key\n    return {\n      statusCode: 200,\n      headers: {\n        'Content-Type': 'text/plain',\n        'Cache-Control': 'no-cache'\n      },\n      body: 'This is a mock response. Configure DEEPSEEK_API_KEY environment variable to enable LLM responses. Based on the context provided, I can see information about research papers, but I need an active API connection to generate proper responses.'\n    };\n  }\n\n  const response = await fetch('https://api.deepseek.com/chat/completions', {\n    method: 'POST',\n    headers: {\n      'Authorization': `Bearer ${apiKey}`,\n      'Content-Type': 'application/json'\n    },\n    body: JSON.stringify({\n      model: 'deepseek-chat',\n      messages: [\n        {\n          role: 'system',\n          content: 'You are a helpful research assistant. Answer questions based on the provided research context. Be concise and accurate. If the context does not contain relevant information, acknowledge this.'\n        },\n        {\n          role: 'user',\n          content: prompt\n        }\n      ],\n      stream: true,\n      max_tokens: 1024\n    })\n  });\n\n  if (!response.ok) {\n    const error = await response.text();\n    throw new Error(`DeepSeek API error: ${response.status} - ${error}`);\n  }\n\n  // Return streaming response\n  return {\n    statusCode: 200,\n    headers: {\n      'Content-Type': 'text/event-stream',\n      'Cache-Control': 'no-cache',\n      'Connection': 'keep-alive'\n    },\n    body: response.body,\n    isBase64Encoded: false\n  };\n}\n\n/**\n * Sanitize input: strip HTML tags and limit length\n */\nfunction sanitizeInput(input) {\n  if (typeof input !== 'string') return '';\n\n  return input\n    .replace(/<[^>]*>/g, '')  // Remove HTML tags\n    .replace(/[<>]/g, '')     // Remove any remaining angle brackets\n    .trim()\n    .slice(0, 2000);\n}\n\n/**\n * Main handler\n */\nexport async function handler(event) {\n  // CORS headers\n  const allowedOrigin = process.env.ALLOWED_ORIGIN || '*';\n  const corsHeaders = {\n    'Access-Control-Allow-Origin': allowedOrigin,\n    'Access-Control-Allow-Methods': 'POST, OPTIONS',\n    'Access-Control-Allow-Headers': 'Content-Type'\n  };\n\n  // Handle preflight\n  if (event.httpMethod === 'OPTIONS') {\n    return {\n      statusCode: 204,\n      headers: corsHeaders,\n      body: ''\n    };\n  }\n\n  // Method check - POST only\n  if (event.httpMethod !== 'POST') {\n    return {\n      statusCode: 405,\n      headers: corsHeaders,\n      body: JSON.stringify({ error: 'Method not allowed' })\n    };\n  }\n\n  // Origin validation (if ALLOWED_ORIGIN is set)\n  if (process.env.ALLOWED_ORIGIN) {\n    const origin = event.headers.origin || event.headers.Origin || '';\n    if (!origin.includes(process.env.ALLOWED_ORIGIN)) {\n      return {\n        statusCode: 403,\n        headers: corsHeaders,\n        body: JSON.stringify({ error: 'Forbidden' })\n      };\n    }\n  }\n\n  // Rate limiting\n  cleanupRateLimits();\n  const ip = event.headers['x-forwarded-for']?.split(',')[0]?.trim() ||\n             event.headers['client-ip'] ||\n             'unknown';\n  const now = Date.now();\n  const limit = rateLimit.get(ip);\n\n  if (limit && now - limit.start < RATE_WINDOW_MS) {\n    if (limit.count >= RATE_LIMIT_MAX) {\n      return {\n        statusCode: 429,\n        headers: {\n          ...corsHeaders,\n          'Retry-After': Math.ceil((RATE_WINDOW_MS - (now - limit.start)) / 1000).toString()\n        },\n        body: JSON.stringify({ error: 'Rate limit exceeded. Please try again later.' })\n      };\n    }\n    limit.count++;\n  } else {\n    rateLimit.set(ip, { start: now, count: 1 });\n  }\n\n  // Parse and validate input\n  let body;\n  try {\n    body = JSON.parse(event.body || '{}');\n  } catch {\n    return {\n      statusCode: 400,\n      headers: corsHeaders,\n      body: JSON.stringify({ error: 'Invalid JSON' })\n    };\n  }\n\n  const query = sanitizeInput(body.query);\n\n  if (!query) {\n    return {\n      statusCode: 400,\n      headers: corsHeaders,\n      body: JSON.stringify({ error: 'Invalid or empty query' })\n    };\n  }\n\n  try {\n    // Vector search\n    let results;\n    const queryVec = await getEmbedding(query);\n\n    if (queryVec) {\n      // Use vector search with embeddings\n      results = search(queryVec, 5);\n    } else {\n      // Fallback to keyword search when no API key\n      results = keywordSearch(query, 5);\n    }\n\n    // Build prompt with context\n    const context = results\n      .filter(r => r.score > 0)\n      .map(r => r.text)\n      .join('\\n\\n---\\n\\n');\n\n    if (!context) {\n      return {\n        statusCode: 200,\n        headers: {\n          ...corsHeaders,\n          'Content-Type': 'application/json'\n        },\n        body: JSON.stringify({\n          response: 'I could not find relevant information in the research database for your query. Please try rephrasing or asking about specific research topics.',\n          sources: []\n        })\n      };\n    }\n\n    const prompt = `Based on the following research context, answer the question.\n\nContext:\n${context}\n\nQuestion: ${query}\n\nProvide a helpful, accurate answer based on the research. If the context doesn't contain relevant information, say so.`;\n\n    // Stream DeepSeek response\n    const llmResponse = await streamDeepSeekResponse(prompt);\n\n    // Add CORS headers to LLM response\n    return {\n      ...llmResponse,\n      headers: {\n        ...corsHeaders,\n        ...llmResponse.headers\n      }\n    };\n\n  } catch (error) {\n    console.error('Chat function error:', error);\n\n    return {\n      statusCode: 500,\n      headers: corsHeaders,\n      body: JSON.stringify({\n        error: 'An error occurred processing your request',\n        details: process.env.NODE_ENV === 'development' ? error.message : undefined\n      })\n    };\n  }\n}\n"],
  "mappings": "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",
  "names": ["require"]
}
