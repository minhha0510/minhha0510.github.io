---
import { getCollection, render } from 'astro:content';
import Layout from '../../layouts/Layout.astro';

export async function getStaticPaths() {
  const posts = await getCollection('posts');
  return posts.map((post) => ({
    params: { slug: post.data.slug },
    props: { post },
  }));
}

const { post } = Astro.props;
const { Content } = await render(post);

const { 
  title, 
  date, 
  readingTime, 
  excerpt, 
  category, 
  tags,
  paperTitle,
  paperUrl,
  journal,
  authors,
  doi 
} = post.data;

// Format date
const formattedDate = new Date(date).toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
});

// Build URLs and prompts
const siteUrl = 'https://minhha0510.github.io';
const postUrl = `${siteUrl}/posts/${post.data.slug}`;

// Create LLM prompts
const blogPrompt = `I'd like to discuss this blog post about pharmacoepidemiology research:

Title: "${title}"
URL: ${postUrl}

Please:
1. Summarize the key findings and their clinical significance
2. Explain the methodology in accessible terms
3. Discuss the strengths and limitations of the research
4. Suggest what questions remain unanswered

Feel free to ask me clarifying questions about what aspects interest me most.`;

const paperPrompt = paperTitle 
  ? `I'd like to analyze this research paper:

Title: "${paperTitle}"
${authors ? `Authors: ${authors}` : ''}
${journal ? `Journal: ${journal}` : ''}
${doi ? `DOI: ${doi}` : ''}

Please provide:
1. A critical appraisal of the study design and methods
2. Evaluation of the statistical analysis approach
3. Assessment of the conclusions' validity
4. Context within the broader literature
5. Suggestions for future research directions`
  : null;
---

<Layout title={title} description={excerpt}>
  <a href="/" class="back-link">
    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
      <path d="M15 19l-7-7 7-7"></path>
    </svg>
    Back to all posts
  </a>

  <article class="post">
    <header class="post-header">
      <div class="post-meta">
        <time datetime={date}>{formattedDate}</time>
        {category && (
          <>
            <span class="meta-separator">·</span>
            <span class="post-category">{category}</span>
          </>
        )}
        <span class="meta-separator">·</span>
        <span>{readingTime} min read</span>
      </div>
      <h1 class="post-title">{title}</h1>
      {excerpt && <p class="post-subtitle">{excerpt}</p>}
    </header>

    <div class="prose">
      <Content />
    </div>

    {tags && tags.length > 0 && (
      <div class="post-tags">
        {tags.map((tag) => (
          <span class="tag">#{tag}</span>
        ))}
      </div>
    )}

    <footer class="post-actions">
      <h2 class="post-actions-title">Explore with AI</h2>
      <p class="post-actions-description">
        Copy a prompt to discuss this post or the original paper with your preferred LLM (ChatGPT, Claude, etc.)
      </p>
      <div class="action-buttons">
        <button 
          class="action-btn primary tooltip" 
          data-prompt={blogPrompt}
          data-tooltip="Copied!"
          onclick="copyPrompt(this)"
        >
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
            <path d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path>
          </svg>
          Discuss this post
        </button>
        
        {paperPrompt && (
          <button 
            class="action-btn tooltip" 
            data-prompt={paperPrompt}
            data-tooltip="Copied!"
            onclick="copyPrompt(this)"
          >
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
              <path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
            Analyze original paper
          </button>
        )}
        
        {paperUrl && (
          <a 
            href={paperUrl} 
            target="_blank" 
            rel="noopener noreferrer"
            class="action-btn"
          >
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
              <path d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
            </svg>
            View paper
          </a>
        )}
      </div>
    </footer>
  </article>
</Layout>

<script>
  async function copyPrompt(button: HTMLButtonElement) {
    const prompt = button.getAttribute('data-prompt');
    if (!prompt) return;

    try {
      await navigator.clipboard.writeText(prompt);
      button.classList.add('show');
      
      setTimeout(() => {
        button.classList.remove('show');
      }, 2000);
    } catch (err) {
      // Fallback
      const textArea = document.createElement('textarea');
      textArea.value = prompt;
      textArea.style.position = 'fixed';
      textArea.style.left = '-999999px';
      document.body.appendChild(textArea);
      textArea.select();
      document.execCommand('copy');
      document.body.removeChild(textArea);
      
      button.classList.add('show');
      setTimeout(() => {
        button.classList.remove('show');
      }, 2000);
    }
  }
</script>

<style>
  .back-link {
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    color: var(--text-light);
    font-size: 0.9rem;
    margin-bottom: 2rem;
  }

  .back-link:hover {
    color: var(--accent);
  }

  .back-link svg {
    width: 16px;
    height: 16px;
  }

  .post {
    max-width: 720px;
    margin: 0 auto;
  }

  .post-header {
    text-align: center;
    margin-bottom: 3rem;
    padding-bottom: 2rem;
    border-bottom: 1px solid var(--border-light);
  }

  .post-meta {
    display: flex;
    align-items: center;
    justify-content: center;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-bottom: 1rem;
    font-size: 0.9rem;
    color: var(--text-light);
  }

  .meta-separator {
    color: var(--border);
  }

  .post-category {
    color: var(--accent);
    font-weight: 500;
  }

  .post-title {
    font-size: 2.25rem;
    font-weight: 700;
    line-height: 1.2;
    margin: 0 0 1rem 0;
    color: var(--text);
  }

  .post-subtitle {
    font-size: 1.125rem;
    color: var(--text-muted);
    line-height: 1.6;
    margin: 0;
  }

  .post-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
    margin-top: 2rem;
    padding-top: 1.5rem;
    border-top: 1px solid var(--border-light);
  }

  .tag {
    font-size: 0.875rem;
    color: var(--text-light);
  }

  .post-actions {
    margin-top: 4rem;
    padding: 2rem;
    background: var(--bg-elevated);
    border: 1px solid var(--border);
    border-radius: 8px;
  }

  .post-actions-title {
    font-size: 1rem;
    font-weight: 600;
    margin: 0 0 0.5rem 0;
    color: var(--text);
  }

  .post-actions-description {
    font-size: 0.9rem;
    color: var(--text-muted);
    margin: 0 0 1.25rem 0;
    line-height: 1.5;
  }

  .action-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
  }

  .action-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.625rem 1rem;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text);
    font-size: 0.9rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    text-decoration: none;
  }

  .action-btn:hover {
    background: var(--border-light);
    border-color: var(--accent);
    text-decoration: none;
    color: var(--text);
  }

  .action-btn svg {
    width: 18px;
    height: 18px;
  }

  .action-btn.primary {
    background: var(--accent);
    border-color: var(--accent);
    color: white;
  }

  .action-btn.primary:hover {
    background: var(--accent-hover);
    border-color: var(--accent-hover);
    color: white;
  }

  /* Tooltip */
  .tooltip {
    position: relative;
  }

  .tooltip::after {
    content: attr(data-tooltip);
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    padding: 0.375rem 0.75rem;
    background: var(--text);
    color: var(--bg);
    font-size: 0.75rem;
    border-radius: 4px;
    white-space: nowrap;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.2s, visibility 0.2s;
    pointer-events: none;
    margin-bottom: 0.5rem;
    font-weight: 500;
  }

  .tooltip.show::after {
    opacity: 1;
    visibility: visible;
  }

  @media (max-width: 640px) {
    .post-title {
      font-size: 1.75rem;
    }

    .post-subtitle {
      font-size: 1rem;
    }

    .post-actions {
      padding: 1.5rem;
      margin-top: 3rem;
    }

    .action-buttons {
      flex-direction: column;
    }

    .action-btn {
      justify-content: center;
    }
  }
</style>
