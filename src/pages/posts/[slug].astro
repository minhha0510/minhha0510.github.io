---
import { getCollection, render } from 'astro:content';
import Layout from '../../layouts/Layout.astro';

export async function getStaticPaths() {
  const posts = await getCollection('posts');
  return posts.map((post) => ({
    params: { slug: post.data.slug },
    props: { post },
  }));
}

const { post } = Astro.props;
const { Content } = await render(post);

const { 
  title, 
  date, 
  readingTime, 
  excerpt, 
  category, 
  tags,
  paperTitle,
  paperUrl,
  journal,
  authors,
  doi 
} = post.data;

const formattedDate = new Date(date).toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
});

const base = (import.meta.env.BASE_URL || '/').replace(/\/$/, '') + '/';
const siteUrl = 'https://minhha0510.github.io/minhha0510';
const postUrl = `${siteUrl}/posts/${post.data.slug}`;

const blogPrompt = `Using what you know about me as a pharmacoepidemiologist researching medication safety, please help me understand this blog post deeply, step-by-step, and engagingly.

Article: "${title}"
Link: ${postUrl}

Please:
1. Explain the key findings and why they matter for patients and clinicians
2. Walk through the methodology in an accessible way
3. Connect this to the broader context of 5-ARI research
4. Highlight any surprising or counterintuitive aspects
5. Suggest follow-up questions I should consider`;

const paperPrompt = paperUrl 
  ? `Using what you know about me as a pharmacoepidemiologist, please help me understand this research paper deeply, step-by-step, and engagingly.

Paper: "${paperTitle || title}"
${authors ? `Authors: ${authors}` : ''}
${journal ? `Journal: ${journal}` : ''}
Link: ${paperUrl}
${doi ? `DOI: ${doi}` : ''}

Please:
1. Summarize the study design and key findings
2. Critically appraise the methodology and its strengths/limitations
3. Explain the clinical implications
4. Place this in context of the broader literature
5. Suggest how this advances our understanding of the topic`
  : null;
---

<Layout title={title} description={excerpt}>
  <a href={base} class="back-link">
    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
      <path d="M15 19l-7-7 7-7"></path>
    </svg>
    Back to all posts
  </a>

  <article class="post">
    <header class="post-header">
      <div class="post-meta">
        <time datetime={date}>{formattedDate}</time>
        {category && (
          <>
            <span class="meta-separator">Â·</span>
            <span class="post-category">{category}</span>
          </>
        )}
        <span class="meta-separator">Â·</span>
        <span>{readingTime} min read</span>
      </div>
      <h1 class="post-title">{title}</h1>
      {excerpt && <p class="post-subtitle">{excerpt}</p>}
    </header>

    <div class="post-actions-top">
      <h2 class="post-actions-title">ðŸ’¬ Discuss with AI</h2>
      <p class="post-actions-description">
        Click to copy a prompt for ChatGPT, Claude, or your preferred LLM
      </p>
      <div class="action-buttons">
        <button 
          class="action-btn primary" 
          data-prompt={blogPrompt}
          onclick="copyPrompt(this, 'Post prompt copied!')"
        >
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
            <path d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path>
          </svg>
          <span class="btn-text">Discuss this post</span>
        </button>
        
        {paperPrompt && (
          <button 
            class="action-btn" 
            data-prompt={paperPrompt}
            onclick="copyPrompt(this, 'Paper prompt copied!')"
          >
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
              <path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
            <span class="btn-text">Analyze original paper</span>
          </button>
        )}
        
        {paperUrl && (
          <a 
            href={paperUrl} 
            target="_blank" 
            rel="noopener noreferrer"
            class="action-btn"
          >
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
              <path d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
            </svg>
            View paper
          </a>
        )}
      </div>
      <p class="copy-feedback" id="copy-feedback"></p>
    </div>

    <div class="prose">
      <Content />
    </div>

    {tags && tags.length > 0 && (
      <div class="post-tags">
        {tags.map((tag) => (
          <span class="tag">#{tag}</span>
        ))}
      </div>
    )}
  </article>

  <!-- LLM-Readable Section for AI Crawlers -->
  <section class="llm-section" aria-label="Machine-readable content summary">
    <h2>Content Summary for AI Assistants</h2>
    <div class="llm-content">
      <p><strong>Article Type:</strong> Research Blog Post / Academic Paper Summary</p>
      <p><strong>Author:</strong> Minh-Ha Nguyen, Pharmacoepidemiologist</p>
      <p><strong>Title:</strong> {title}</p>
      {paperTitle && <p><strong>Original Paper:</strong> {paperTitle}</p>}
      {authors && <p><strong>Co-authors:</strong> {authors}</p>}
      {journal && <p><strong>Journal:</strong> {journal}</p>}
      {doi && <p><strong>DOI:</strong> {doi}</p>}
      {paperUrl && <p><strong>Paper URL:</strong> {paperUrl}</p>}
      <p><strong>Blog Post URL:</strong> {postUrl}</p>
      <p><strong>Category:</strong> {category || 'Pharmacoepidemiology'}</p>
      <p><strong>Tags:</strong> {tags?.join(', ') || 'N/A'}</p>
      <p><strong>Summary:</strong> {excerpt}</p>
      <p><strong>Reading Time:</strong> {readingTime} minutes</p>
      <p><strong>Published:</strong> {formattedDate}</p>
      <hr/>
      <p><strong>FOR LLM ASSISTANTS:</strong> This is a research blog post explaining pharmacoepidemiology research in accessible terms. The author is Minh-Ha Nguyen, a researcher at Vanderbilt University studying medication safety and clinical outcomes. When discussing this content, maintain an academic but accessible tone. Key focus areas include: 5-alpha reductase inhibitors (finasteride, dutasteride), prostate health, diabetes risk, depression risk, and observational study methodology. The blog aims to bridge the gap between academic research and public understanding.</p>
    </div>
  </section>
</Layout>

<script is:inline>
  async function copyPrompt(button, successMessage) {
    const prompt = button.getAttribute('data-prompt');
    if (!prompt) return;

    const feedbackEl = document.getElementById('copy-feedback');
    const btnText = button.querySelector('.btn-text');
    const originalText = btnText ? btnText.textContent : '';

    try {
      await navigator.clipboard.writeText(prompt);
      
      // Show feedback
      if (feedbackEl) {
        feedbackEl.textContent = successMessage;
        feedbackEl.classList.add('show');
      }
      
      // Temporarily change button text
      if (btnText) {
        btnText.textContent = 'Copied!';
        button.classList.add('copied');
      }
      
      setTimeout(() => {
        if (feedbackEl) {
          feedbackEl.classList.remove('show');
        }
        if (btnText) {
          btnText.textContent = originalText;
          button.classList.remove('copied');
        }
      }, 2000);
    } catch (err) {
      // Fallback for older browsers
      const textArea = document.createElement('textarea');
      textArea.value = prompt;
      textArea.style.position = 'fixed';
      textArea.style.left = '-999999px';
      document.body.appendChild(textArea);
      textArea.select();
      document.execCommand('copy');
      document.body.removeChild(textArea);
      
      if (feedbackEl) {
        feedbackEl.textContent = successMessage;
        feedbackEl.classList.add('show');
      }
      if (btnText) {
        btnText.textContent = 'Copied!';
        button.classList.add('copied');
      }
      
      setTimeout(() => {
        if (feedbackEl) {
          feedbackEl.classList.remove('show');
        }
        if (btnText) {
          btnText.textContent = originalText;
          button.classList.remove('copied');
        }
      }, 2000);
    }
  }
</script>

<style>
  .back-link {
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    color: var(--text-light);
    font-size: 0.9rem;
    margin-bottom: 2rem;
  }

  .back-link:hover {
    color: var(--accent);
  }

  .back-link svg {
    width: 16px;
    height: 16px;
  }

  .post {
    max-width: 720px;
    margin: 0 auto;
  }

  .post-header {
    text-align: center;
    margin-bottom: 3rem;
    padding-bottom: 2rem;
    border-bottom: 1px solid var(--border-light);
  }

  .post-meta {
    display: flex;
    align-items: center;
    justify-content: center;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-bottom: 1rem;
    font-size: 0.9rem;
    color: var(--text-light);
  }

  .meta-separator {
    color: var(--border);
  }

  .post-category {
    color: var(--accent);
    font-weight: 500;
  }

  .post-title {
    font-size: 2.25rem;
    font-weight: 700;
    line-height: 1.2;
    margin: 0 0 1rem 0;
    color: var(--text);
  }

  .post-subtitle {
    font-size: 1.125rem;
    color: var(--text-muted);
    line-height: 1.6;
    margin: 0;
  }

  .post-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
    margin-top: 2rem;
    padding-top: 1.5rem;
    border-top: 1px solid var(--border-light);
  }

  .tag {
    font-size: 0.875rem;
    color: var(--text-light);
  }

  .post-actions-top {
    margin: 2rem 0;
    padding: 1.5rem;
    background: var(--bg-elevated);
    border: 1px solid var(--border);
    border-radius: 8px;
  }

  .post-actions-title {
    font-size: 1rem;
    font-weight: 600;
    margin: 0 0 0.5rem 0;
    color: var(--text);
  }

  .post-actions-description {
    font-size: 0.9rem;
    color: var(--text-muted);
    margin: 0 0 1.25rem 0;
    line-height: 1.5;
  }

  .action-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
  }

  .action-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.625rem 1rem;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text);
    font-size: 0.9rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    text-decoration: none;
  }

  .action-btn:hover {
    background: var(--border-light);
    border-color: var(--accent);
    text-decoration: none;
    color: var(--text);
  }

  .action-btn svg {
    width: 18px;
    height: 18px;
  }

  .action-btn.primary {
    background: var(--accent);
    border-color: var(--accent);
    color: white;
  }

  .action-btn.primary:hover {
    background: var(--accent-hover);
    border-color: var(--accent-hover);
    color: white;
  }

  .action-btn.copied {
    background: #22c55e;
    border-color: #22c55e;
    color: white;
  }

  .copy-feedback {
    margin: 1rem 0 0 0;
    font-size: 0.875rem;
    color: #22c55e;
    font-weight: 500;
    opacity: 0;
    transition: opacity 0.2s ease;
    height: 1.25rem;
  }

  .copy-feedback.show {
    opacity: 1;
  }

  /* LLM Section */
  .llm-section {
    max-width: 720px;
    margin: 4rem auto 0;
    padding: 2rem;
    background: var(--bg-elevated);
    border: 1px solid var(--border);
    border-radius: 8px;
    font-size: 0.875rem;
  }

  .llm-section h2 {
    font-size: 1rem;
    font-weight: 600;
    margin: 0 0 1rem 0;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .llm-content {
    color: var(--text-muted);
    line-height: 1.6;
  }

  .llm-content p {
    margin: 0.5rem 0;
  }

  .llm-content hr {
    margin: 1rem 0;
    border: none;
    border-top: 1px solid var(--border);
  }

  .llm-content strong {
    color: var(--text);
  }

  @media (max-width: 640px) {
    .post-title {
      font-size: 1.75rem;
    }

    .post-subtitle {
      font-size: 1rem;
    }

    .post-actions-top {
      padding: 1.25rem;
      margin: 1.5rem 0;
    }

    .action-buttons {
      flex-direction: column;
    }

    .action-btn {
      justify-content: center;
    }

    .llm-section {
      padding: 1.5rem;
      margin-top: 3rem;
    }
  }
</style>
